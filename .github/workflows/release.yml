name: Publish Package

on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  build:
    name: Download and Push Package
    runs-on: ubuntu-latest

    permissions:
      contents: read

    env:
      PROJECT_NAME: 'sbcwallet'

    steps:
    - uses: actions/checkout@v4
      name: Checkout

    - uses: actions/setup-node@v4
      with:
        node-version: 18
        registry-url: 'https://registry.npmjs.org'
        always-auth: true

    - name: Package Name
      run: |
        echo RELEASE_NAME=${{ env.PROJECT_NAME }}-${{ github.event.release.tag_name }}.tgz >> $GITHUB_ENV
      shell: bash

    - name: Log Variables
      run: |
        echo "action - ${{ github.event.action }}"
        echo "url - ${{ github.event.release.url }}"
        echo "assets_url - ${{ github.event.release.assets_url }}"
        echo "id - ${{ github.event.release.id }}"
        echo "tag_name - ${{ github.event.release.tag_name }}"
        echo "assets - ${{ github.event.release.assets }}"
        echo "assets[0] - ${{ github.event.release.assets[0] }}"

    - name: Download release
      uses: sondreb/action-release-download@master
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        url: ${{ github.event.release.assets_url }}
        folder: "./"

    - name: Display structure of downloaded files
      run: |
        echo "PWD: $(pwd)"
        ls -la
        echo "----"
        find . -maxdepth 2 -type f -print

    - name: Resolve tarball filename
      id: tarball
      shell: bash
      run: |
        set -euo pipefail

        # Prefer the expected release name, but fall back to "any .tgz".
        if [[ -f "${RELEASE_NAME}" ]]; then
          TARBALL="${RELEASE_NAME}"
        else
          TARBALL=$(ls -1 *.tgz 2>/dev/null | head -n 1 || true)
        fi

        if [[ -z "${TARBALL}" ]]; then
          echo "No .tgz found in workspace root." >&2
          echo "Expected: ${RELEASE_NAME}" >&2
          exit 1
        fi

        echo "TARBALL=${TARBALL}" >> "$GITHUB_ENV"
        echo "Using tarball: ${TARBALL}"

    - name: NPM Publish
      run: npm publish "${{ env.TARBALL }}" --access public
      env:
        NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}